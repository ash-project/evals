id: ecosystem.ash.require_ash_query.v1
description: "Tests fixing a bug where Ash.Query needs to be required before use."
difficulty: easy
tags: [ecosystem, ash, debugging]
type: write_code_and_assert
code: |
  defmodule MyApp.Blog.Post do
    use Ash.Resource,
      data_layer: Ash.DataLayer.Ets,
      domain: nil,
      validate_domain_inclusion?: false

    attributes do
      uuid_primary_key :id
      attribute :title, :string, allow_nil?: false
    end
  end

  defmodule PostFilterer do
    def filter_posts() do
      Ash.Query.filter(MyApp.Blog.Post, title == "Ash")
    end
  end

  result = PostFilterer.filter_posts()
messages:
  - type: user
    text: Please fix the bug in the `PostFilterer` module such that the `result` variable contains a query to filter posts by title. The bug is a compile-time error.
install:
  - package: ash
    version: ~> 3.5
eval:
  assert:
    assertion: |
      # The provided code snippet won't compile without the fix.
      # The LLM must add `require Ash.Query` to `PostFilterer`.
      # We assert the structure of the resulting query.
      inspect(result.filter) == "#Ash.Filter<title == \"Ash\">"
